<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculadoras e Predi√ß√£o</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBbRMgIBPBTcPXAa00KYfxÁÆ°ZTCMrTGccw4iSdBNNWY=" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {font-family: "Times New Roman", serif; background-color: #07251F; color: #EAF9E1; margin: 10px; padding: 10px;}
        h2, h3 {text-align: center;}
        label, input, select, button, .resultado, .report-preview-item {font-family: "Times New Roman", serif; display: block; width: 100%; max-width: 100%; margin: 10px 0; padding: 10px; border-radius: 12px; box-sizing: border-box; font-size: 16px;}
        input, select {background-color: #EAF9E1; color: #07251F; border: 1px solid #07251F;}
        button {background-color: #d4af37; color: #07251F; border: none; font-weight: bold; cursor: pointer; width: auto; display: inline-block; margin-right: 10px; margin-top: 20px;}
        button:hover {opacity: 0.9;}
        .resultado {background-color: #103a2f; color: #EAF9E1; display: none; white-space: pre-wrap; padding: 15px; border: 1px solid #d4af37; margin-top: 10px; line-height: 1.6;}
        button.report-action {background-color: #0f4c3a; color: #EAF9E1; border: 1px solid #d4af37;}
        .botoes-container {display: flex; gap: 10px; margin-top: 10px; margin-bottom: 10px; flex-wrap: wrap;}
        .context-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;}
        fieldset {border: 1px solid #2a5a4a; border-radius: 8px; padding: 10px 15px; margin-top: 15px;}
        legend {padding: 0 10px; font-weight: bold; color: #d4af37;}
        fieldset label {display: flex; align-items: center; margin: 8px 0; padding: 0; font-size: 15px; cursor: pointer;}
        fieldset input[type="checkbox"] {width: auto; margin-right: 10px;}
        blockquote {background-color: #103a2f; border-left: 5px solid #d4af37; margin: 20px 0; padding: 15px; font-style: italic;}
        #menu {display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;}
        #menu button {background-color: #103a2f; color: #EAF9E1; border: 1px solid #d4af37; margin-top: 0;}
        #menu button.active {background-color: #d4af37; color: #07251F;}
        .calculadora-container {display: none;}
        .adjusted-projection-display {background-color: #103a2f; padding: 10px; margin-top: 20px; border-radius: 8px; text-align: center; border: 1px dashed #d4af37; display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;}
        .adjusted-projection-display span {font-size: 16px;}
        .adjusted-projection-display strong {color: #d4af37; font-size: 18px; display: block; margin-top: 4px;}
        #previewRelatorio {min-height: 100px; max-height: 300px; overflow-y: auto; border: 1px dashed #d4af37; padding: 10px; margin-top: 10px; background-color: #07251F;}
        .report-preview-item {font-size: 14px; margin-bottom: 5px; padding: 8px; background-color: #1a5947; white-space: pre-wrap; border: 1px solid #2a5a4a; word-wrap: break-word;}
        .report-preview-item strong {color: #d4af37; display: block; margin-bottom: 5px; font-size: 16px;}
        .dutch-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 15px;}
        hr.input-divider { border: none; border-top: 1px dashed #2a5a4a; margin: 15px 0; }
        @media (max-width: 600px) {
            .context-grid, .dutch-grid {grid-template-columns: 1fr;}
        }
    </style>
</head>
<body>
    <h2 style="color: #d4af37;">Su√≠te de An√°lise Preditiva e Gest√£o</h2>
    <div id="menu">
        <button onclick="showCalculator('contexto')">üìù Contexto da Partida</button>
        <button onclick="showCalculator('gols')">‚öΩ Gols e Resultado</button>
        <button onclick="showCalculator('sot_saves')">ü•Ö Finaliza√ß√µes no Gol e Defesas</button>
        <button onclick="showCalculator('finalizacoes')">üéØ Total de Finaliza√ß√µes</button>
        <button onclick="showCalculator('escanteios')">üìê Escanteios</button>
        <button onclick="showCalculator('cartoes')">üü® Cart√µes</button>
        <button onclick="showCalculator('faltas')">üöß Faltas</button>
        <button onclick="showCalculator('apostas')">üí∞ Gest√£o de Apostas</button>
        <button onclick="showCalculator('relatorio')">üìã Relat√≥rio</button>
    </div>

    <div id="calculadora-contexto" class="calculadora-container">
        <h3>Contexto da Partida</h3>
        <blockquote style="text-align: center;">Defina aqui os par√¢metros globais da partida. Estes fatores ajustar√£o as proje√ß√µes nas outras calculadoras.</blockquote>

        <fieldset>
            <legend>Identifica√ß√£o da Partida</legend>
            <div class="context-grid">
                <div>
                    <label for="ctx_home">Mandante</label>
                    <select id="ctx_home" onchange="preencherDados()">
                        <option value="">Selecione o Mandante</option>
                        <option value="Corinthians">Corinthians</option>
                        <option value="Palmeiras">Palmeiras</option>
                        <option value="Santos">Santos</option>
                        <option value="Sao_Paulo">S√£o Paulo</option>
                        <option value="Flamengo">Flamengo</option>
                        <option value="Vasco">Vasco da Gama</option>
                        <option value="Fluminense">Fluminense</option>
                        <option value="Botafogo">Botafogo</option>
                    </select>
                </div>
                <div>
                    <label for="ctx_away">Visitante</label>
                    <select id="ctx_away" onchange="preencherDados()">
                        <option value="">Selecione o Visitante</option>
                        <option value="Corinthians">Corinthians</option>
                        <option value="Palmeiras">Palmeiras</option>
                        <option value="Santos">Santos</option>
                        <option value="Sao_Paulo">S√£o Paulo</option>
                        <option value="Flamengo">Flamengo</option>
                        <option value="Vasco">Vasco da Gama</option>
                        <option value="Fluminense">Fluminense</option>
                        <option value="Botafogo">Botafogo</option>
                    </select>
                </div>
            </div>
            <label for="ctx_championship">Campeonato</label>
            <select id="ctx_championship">
                <option value="">Selecione o Campeonato</option>
                <option value="Brasileirao_A">Brasileir√£o S√©rie A</option>
                <option value="Brasileirao_B">Brasileir√£o S√©rie B</option>
                <option value="Copa_Brasil">Copa do Brasil</option>
                <option value="Libertadores">Copa Libertadores</option>
            </select>
        </fieldset>

        <fieldset>
            <legend style="font-size: 1.1em; color: #FFD700;">üéØ Vi√©s de An√°lise da Partida</legend>
            <p style="font-size:13px; text-align:center; font-style:italic; margin: -5px 0 10px 0;">
                Ajuste global que reflete sua expectativa sobre a din√¢mica do jogo.
                "Arrojado" amplifica o favoritismo; "Conservador" equilibra e reduz o volume geral.
            </p>
            <select id="ctx_analytical_bias">
                <option value="neutro" selected>Neutro (Padr√£o)</option>
                <option value="arrojado">Arrojado (Ampliar Favoritismo)</option>
                <option value="conservador">Conservador (Equilibrar / Menor Volume)</option>
            </select>
        </fieldset>

        <fieldset>
            <legend>Fatores Contextuais Gerais</legend>
             <label for="ctx_stadium_attendance">P√∫blico no Est√°dio</label>
             <select id="ctx_stadium_attendance">
                 <option value="medio">P√∫blico M√©dio (Padr√£o)</option>
                 <option value="lotado">Lotado</option>
                 <option value="vazio">Port√µes Fechados</option>
             </select>
             <label><input type="checkbox" id="ctx_altitude"/> Altitude Elevada</label>
             <label><input type="checkbox" id="ctx_bad_weather"/> Clima Adverso (Ex: Chuva Forte)</label>
             <label><input type="checkbox" id="ctx_derby"/> Alta Rivalidade (Cl√°ssico/Final)</label>
        </fieldset>

        <div class="context-grid">
            <fieldset>
                <legend>Fatores Espec√≠ficos (Mandante)</legend>
                <label><input type="checkbox" id="ctx_home_short_rest"/> Descanso Curto (&lt;3 dias)</label>
                <label><input type="checkbox" id="ctx_home_must_win"/> Alta Motiva√ß√£o (Decisivo)</label>
                <label><input type="checkbox" id="ctx_home_no_motivation"/> Baixa Motiva√ß√£o (Protocolar)</label>
                <label><input type="checkbox" id="ctx_home_foco_outro_jogo"/> Foco em Outra Competi√ß√£o (Escala√ß√£o Alternativa)</label>
                <label><input type="checkbox" id="ctx_home_attack_absences"/> Desfalques Chave no Ataque</label>
                <label><input type="checkbox" id="ctx_home_defense_absences"/> Desfalques Chave na Defesa</label>
                <label><input type="checkbox" id="ctx_home_new_manager"/> Mudan√ßa Recente Relevante (Ex: Novo T√©cnico)</label>
            </fieldset>
            <fieldset>
                <legend>Fatores Espec√≠ficos (Visitante)</legend>
                <label><input type="checkbox" id="ctx_away_short_rest"/> Descanso Curto (&lt;3 dias)</label>
                <label><input type="checkbox" id="ctx_away_long_travel"/> Viagem Desgastante</label>
                <label><input type="checkbox"id="ctx_away_must_win"/> Alta Motiva√ß√£o (Decisivo)</label>
                <label><input type="checkbox" id="ctx_away_no_motivation"/> Baixa Motiva√ß√£o (Protocolar)</label>
                <label><input type="checkbox" id="ctx_away_foco_outro_jogo"/> Foco em Outra Competi√ß√£o (Escala√ß√£o Alternativa)</label>
                <label><input type="checkbox" id="ctx_away_attack_absences"/> Desfalques Chave no Ataque</label>
                <label><input type="checkbox" id="ctx_away_defense_absences"/> Desfalques Chave na Defesa</label>
                <label><input type="checkbox" id="ctx_away_new_manager"/> Mudan√ßa Recente Relevante (Ex: Novo T√©cnico)</label>
            </fieldset>
        </div>

        <fieldset>
            <legend>Arbitragem</legend>
            <div class="context-grid">
                <div><label for="ctx_referee_fouls">M√©dia de Faltas do √Årbitro (Opcional)</label><input type="text" id="ctx_referee_fouls"/></div>
                <div><label for="ctx_referee_cards">M√©dia de Cart√µes do √Årbitro (Opcional)</label><input type="text" id="ctx_referee_cards"/></div>
            </div>
            <label for="ctx_referee_style">Perfil do √Årbitro</label>
            <select id="ctx_referee_style">
                <option value="normal">Normal (Padr√£o)</option>
                <option value="rigido">R√≠gido</option>
                <option value="permissivo">Permissivo</option>
            </select>
        </fieldset>
    </div>

    <div id="calculadora-gols" class="calculadora-container">
        <h3>Calculadora de Gols e Resultado</h3>
        <fieldset><legend>1. Desempenho Base e H2H</legend>
            <label for="gols_xg_proprio_casa">xG Pr√≥prio do Mandante (em casa)</label><input type="text" id="gols_xg_proprio_casa"/>
            <label for="gols_xga_oponente_visitante">xGA Sofrido pelo Visitante (fora de casa)</label><input type="text" id="gols_xga_oponente_visitante"/>
            <hr class="input-divider">
            <label for="gols_xg_proprio_visitante">xG Pr√≥prio do Visitante (fora de casa)</label><input type="text" id="gols_xg_proprio_visitante"/>
            <label for="gols_xga_oponente_casa">xGA Sofrido pelo Mandante (em casa)</label><input type="text" id="gols_xga_oponente_casa"/>
            <hr class="input-divider">
            <label for="gols_xg_h2h_casa">xG Pr√≥prio do Mandante no H2H (em casa, opcional)</label><input type="text" id="gols_xg_h2h_casa"/>
            <label for="gols_xga_h2h_visitante">xGA Sofrido pelo Visitante no H2H (fora, opcional)</label><input type="text" id="gols_xga_h2h_visitante"/>
             <hr class="input-divider">
            <label for="gols_xg_h2h_visitante">xG Pr√≥prio do Visitante no H2H (fora, opcional)</label><input type="text" id="gols_xg_h2h_visitante"/>
            <label for="gols_xga_h2h_casa">xGA Sofrido pelo Mandante no H2H (em casa, opcional)</label><input type="text" id="gols_xga_h2h_casa"/>
        </fieldset>
        <fieldset><legend>2. Efici√™ncia de Convers√£o (Opcional, Baseada em Dados)</legend>
            <p style="font-size:13px; text-align:center; font-style:italic; margin: -5px 0 15px 0;">Use dados da mesma competi√ß√£o/condi√ß√£o para maior precis√£o.</p>
            <div class="context-grid">
                <div>
                    <label for="gols_marcados_casa">Gols Marcados pelo Mandante (em casa)</label><input type="text" id="gols_marcados_casa"/>
                    <label for="gols_xg_casa">xG Acumulado do Mandante (em casa)</label><input type="text" id="gols_xg_casa"/>
                </div>
                 <div>
                    <label for="gols_marcados_visitante">Gols Marcados pelo Visitante (fora de casa)</label><input type="text" id="gols_marcados_visitante"/>
                    <label for="gols_xg_visitante">xG Acumulado do Visitante (fora de casa)</label><input type="text" id="gols_xg_visitante"/>
                </div>
            </div>
        </fieldset>
        <div class="adjusted-projection-display">
            <span>Œª Mandante FINAL<strong id="displayLambdaCasa">0,000</strong></span>
            <span>Œª Visitante FINAL<strong id="displayLambdaVisitante">0,000</strong></span>
        </div>
        <button onclick="calcularDixonColes()">Calcular Proje√ß√£o de Gols</button>
        <button class="report-action" onclick="adicionarAoRelatorio('gols')">Adicionar ao Relat√≥rio</button>
        <div class="resultado" id="resultado_gols"></div>
    </div>

    <div id="calculadora-sot_saves" class="calculadora-container">
        <h3>Calculadora de Finaliza√ß√µes no Gol e Defesas</h3>
        <fieldset><legend>1. Desempenho Base e Goleiros</legend>
            <label for="sot_saves_pro_casa">Finaliza√ß√µes no Gol Pr√≥-Mandante (em casa)</label><input type="text" id="sot_saves_pro_casa"/>
            <label for="sot_saves_contra_visitante">Finaliza√ß√µes no Gol Cedidas pelo Visitante (fora de casa)</label><input type="text" id="sot_saves_contra_visitante"/>
            <hr class="input-divider">
            <label for="sot_saves_pro_visitante">Finaliza√ß√µes no Gol Pr√≥-Visitante (fora de casa)</label><input type="text" id="sot_saves_pro_visitante"/>
            <label for="sot_saves_contra_casa">Finaliza√ß√µes no Gol Cedidas pelo Mandante (em casa)</label><input type="text" id="sot_saves_contra_casa"/>
            <hr class="input-divider">
            <label for="sot_saves_gk_savepct_casa">% Defesas do Goleiro Mandante (Opcional)</label>
            <input type="text" id="sot_saves_gk_savepct_casa"/>
            <label for="sot_saves_gk_savepct_visitante">% Defesas do Goleiro Visitante (Opcional)</label>
            <input type="text" id="sot_saves_gk_savepct_visitante"/>
        </fieldset>
        <div class="adjusted-projection-display">
            <span>SoT Mandante FINAL<strong id="displaySotCasa">0,0</strong></span>
            <span>SoT Visitante FINAL<strong id="displaySotVisitante">0,0</strong></span>
        </div>
        <button onclick="calcularSoTSaves()">Calcular SoT e Defesas</button>
        <button class="report-action" onclick="adicionarAoRelatorio('sot_saves')">Adicionar ao Relat√≥rio</button>
        <div class="resultado" id="resultado_sot_saves"></div>
    </div>
    
    <div id="calculadora-finalizacoes" class="calculadora-container">
        <h3>Calculadora de Total de Finaliza√ß√µes</h3>
        <fieldset><legend>1. Desempenho Base</legend>
            <label for="finalizacoes_pro_casa">M√©dia de Finaliza√ß√µes Pr√≥-Mandante (em casa)</label><input type="text" id="finalizacoes_pro_casa"/>
            <label for="finalizacoes_contra_visitante">M√©dia de Finaliza√ß√µes Cedidas pelo Visitante (fora de casa)</label><input type="text" id="finalizacoes_contra_visitante"/>
            <hr class="input-divider">
            <label for="finalizacoes_pro_visitante">M√©dia de Finaliza√ß√µes Pr√≥-Visitante (fora de casa)</label><input type="text" id="finalizacoes_pro_visitante"/>
            <label for="finalizacoes_contra_casa">M√©dia de Finaliza√ß√µes Cedidas pelo Mandante (em casa)</label><input type="text" id="finalizacoes_contra_casa"/>
        </fieldset>
        <div class="adjusted-projection-display">
            <span>Finaliza√ß√µes Mandante FINAL<strong id="displayFinCasa">0,0</strong></span>
            <span>Finaliza√ß√µes Visitante FINAL<strong id="displayFinVisitante">0,0</strong></span>
        </div>
        <button onclick="calcularFinalizacoes()">Calcular Total de Finaliza√ß√µes</button>
        <button class="report-action" onclick="adicionarAoRelatorio('finalizacoes')">Adicionar ao Relat√≥rio</button>
        <div class="resultado" id="resultado_finalizacoes"></div>
    </div>

    <div id="calculadora-escanteios" class="calculadora-container">
        <h3>Calculadora de Escanteios</h3>
        <fieldset><legend>1. Desempenho Base</legend>
            <label for="escanteios_pro_casa">M√©dia de Escanteios Pr√≥-Mandante (em casa)</label><input type="text" id="escanteios_pro_casa"/>
            <label for="escanteios_contra_visitante">M√©dia de Escanteios Cedidos pelo Visitante (fora de casa)</label><input type="text" id="escanteios_contra_visitante"/>
            <hr class="input-divider">
            <label for="escanteios_pro_visitante">M√©dia de Escanteios Pr√≥-Visitante (fora de casa)</label><input type="text" id="escanteios_pro_visitante"/>
            <label for="escanteios_contra_casa">M√©dia de Escanteios Cedidos pelo Mandante (em casa)</label><input type="text" id="escanteios_contra_casa"/>
        </fieldset>
         <div class="adjusted-projection-display">
            <span>Escanteios Mandante FINAL<strong id="displayEscCasa">0,0</strong></span>
            <span>Escanteios Visitante FINAL<strong id="displayEscVisitante">0,0</strong></span>
        </div>
        <button onclick="calcularEscanteios()">Calcular Escanteios</button>
        <button class="report-action" onclick="adicionarAoRelatorio('escanteios')">Adicionar ao Relat√≥rio</button>
        <div class="resultado" id="resultado_escanteios"></div>
    </div>

    <div id="calculadora-cartoes" class="calculadora-container">
        <h3>Calculadora de Cart√µes</h3>
        <fieldset><legend>1. Desempenho Base e H2H</legend>
            <label for="cartoes_media_arbitro">M√©dia de Cart√µes do √Årbitro</label><input type="text" id="cartoes_media_arbitro"/>
            <hr class="input-divider">
            <label for="cartoes_time_casa">M√©dia de Cart√µes do Mandante (em casa)</label><input type="text" id="cartoes_time_casa"/>
            <label for="cartoes_time_visitante">M√©dia de Cart√µes do Visitante (fora de casa)</label><input type="text" id="cartoes_time_visitante"/>
            <hr class="input-divider">
            <label for="cartoes_h2h_casa">Cart√µes do Mandante no H2H (Opcional)</label><input type="text" id="cartoes_h2h_casa"/>
            <label for="cartoes_h2h_visitante">Cart√µes do Visitante no H2H (Opcional)</label><input type="text" id="cartoes_h2h_visitante"/>
        </fieldset>
        <div class="adjusted-projection-display">
            <span>Cart√µes Mandante FINAL<strong id="displayCartCasa">0,0</strong></span>
            <span>Cart√µes Visitante FINAL<strong id="displayCartVisitante">0,0</strong></span>
        </div>
        <button onclick="calcularCartoes()">Calcular Cart√µes</button>
        <button class="report-action" onclick="adicionarAoRelatorio('cartoes')">Adicionar ao Relat√≥rio</button>
        <div class="resultado" id="resultado_cartoes"></div>
    </div>
    
    <div id="calculadora-faltas" class="calculadora-container">
        <h3>Calculadora de Faltas</h3>
        <fieldset><legend>1. Desempenho Base, √Årbitro e H2H</legend>
            <label for="faltas_media_arbitro">M√©dia de Faltas do √Årbitro</label><input type="text" id="faltas_media_arbitro"/>
            <hr class="input-divider">
            <label for="faltas_cometidas_media_casa">M√©dia de Faltas Cometidas pelo Mandante (em casa)</label><input type="text" id="faltas_cometidas_media_casa"/>
            <label for="faltas_sofridas_media_visitante">M√©dia de Faltas Sofridas pelo Visitante (fora de casa)</label><input type="text" id="faltas_sofridas_media_visitante"/>
            <hr class="input-divider">
            <label for="faltas_cometidas_media_visitante">M√©dia de Faltas Cometidas pelo Visitante (fora de casa)</label><input type="text" id="faltas_cometidas_media_visitante"/>
            <label for="faltas_sofridas_media_casa">M√©dia de Faltas Sofridas pelo Mandante (em casa)</label><input type="text" id="faltas_sofridas_media_casa"/>
            <hr class="input-divider">
            <label for="faltas_cometidas_h2h_casa">Faltas Cometidas pelo Mandante no H2H (vs Visitante, em casa, opcional)</label><input type="text" id="faltas_cometidas_h2h_casa"/>
            <label for="faltas_sofridas_h2h_visitante">Faltas Sofridas pelo Visitante no H2H (vs Mandante, fora, opcional)</label><input type="text" id="faltas_sofridas_h2h_visitante"/>
            <hr class="input-divider">
            <label for="faltas_cometidas_h2h_visitante">Faltas Cometidas pelo Visitante no H2H (vs Mandante, fora, opcional)</label><input type="text" id="faltas_cometidas_h2h_visitante"/>
            <label for="faltas_sofridas_h2h_casa">Faltas Sofridas pelo Mandante no H2H (vs Visitante, em casa, opcional)</label><input type="text" id="faltas_sofridas_h2h_casa"/>
        </fieldset>
        <div class="adjusted-projection-display">
            <span>Faltas Mandante FINAL<strong id="displayFaltasCasa">0,0</strong></span>
            <span>Faltas Visitante FINAL<strong id="displayFaltasVisitante">0,0</strong></span>
        </div>
        <button onclick="calcularFaltas()">Calcular Faltas</button>
        <button class="report-action" onclick="adicionarAoRelatorio('faltas')">Adicionar ao Relat√≥rio</button>
        <div class="resultado" id="resultado_faltas"></div>
    </div>

    <div id="calculadora-apostas" class="calculadora-container">
        <h3>Calculadoras de Gest√£o de Apostas</h3>
        <fieldset>
            <legend>Calculadora de Unidade (Crit√©rio de Kelly)</legend>
            <label for="kelly_banca">Valor Total da Banca (R$)</label><input type="text" id="kelly_banca"/>
            <label for="kelly_odd">Odd </label><input type="text" id="kelly_odd"/>
            <label for="kelly_prob">Probabilidade (%)</label><input type="text" id="kelly_prob"/>
            <label for="kelly_fator">Fator de Risco (Kelly Fracionado)</label>
            <select id="kelly_fator">
                <option value="1">Full Kelly (Risco M√°ximo)</option>
                <option value="0.5" selected>Half Kelly (Recomendado)</option>
                <option value="0.25">Quarter Kelly (Conservador)</option>
            </select>
            <button onclick="calcularKelly()">Calcular Unidade</button>
            <button class="report-action" onclick="adicionarAoRelatorio('kelly')">Adicionar ao Relat√≥rio</button>
            <div class="resultado" id="resultado_kelly"></div>
        </fieldset>
        <fieldset>
            <legend>Calculadora de Cobertura (Hedge)</legend>
            <label for="hedge_valor1">Valor da 1¬™ Aposta</label><input type="text" id="hedge_valor1"/>
            <label for="hedge_odd1">1¬™ Odd</label><input type="text" id="hedge_odd1"/>
            <label for="hedge_odd2">2¬™ Odd (Odd de Cobertura)</label><input type="text" id="hedge_odd2"/>
            <label for="hedge_valor2">Valor da 2¬™ Aposta (opcional)</label><input type="text" id="hedge_valor2"/>
            <div class="botoes-container">
                <button onclick="calcularHedge()">Calcular Cobertura</button>
                <button onclick="fecharPosicao()">Fechar Posi√ß√£o (Lucro Igual)</button>
            </div>
            <button class="report-action" onclick="adicionarAoRelatorio('hedge')">Adicionar ao Relat√≥rio</button>
            <div class="resultado" id="resultado_hedge"></div>
        </fieldset>
        <fieldset>
            <legend>Calculadora de Dutching (Valor Total)</legend>
            <label for="dutch_total_valor">Valor Total a ser Apostado</label><input type="text" id="dutch_total_valor"/>
            <div class="dutch-grid">
                <div><label>1¬™ Odd</label><input type="text" id="dutch_total_odd1" /></div>
                <div><label>2¬™ Odd</label><input type="text" id="dutch_total_odd2" /></div>
                <div><label>3¬™ Odd</label><input type="text" id="dutch_total_odd3" /></div>
                <div><label>4¬™ Odd</label><input type="text" id="dutch_total_odd4" /></div>
            </div>
            <button onclick="calcularDutchingPorTotal()">Calcular Dutching Total</button>
            <button class="report-action" onclick="adicionarAoRelatorio('dutching_total')">Adicionar ao Relat√≥rio</button>
            <div class="resultado" id="resultado_dutching_total"></div>
        </fieldset>
        <fieldset>
            <legend>Calculadora de Dutching (Otimizado por Probabilidade)</legend>
            <label for="dutch_prob_total_valor">Valor Total a ser Apostar</label><input type="text" id="dutch_prob_total_valor"/>
            <div class="dutch-grid">
                <div><label>1¬™ Odd</label><input type="text" id="dutch_prob_odd_1"/></div>
                <div><label>Probabildade 1 (%)</label><input type="text" id="dutch_prob_chance_1"/></div>
                <div><label>2¬™ Odd</label><input type="text" id="dutch_prob_odd_2"/></div>
                <div><label>Probabildade 2 (%)</label><input type="text" id="dutch_prob_chance_2"/></div>
                <div><label>3¬™ Odd</label><input type="text" id="dutch_prob_odd_3"/></div>
                <div><label>Probabildade 3 (%)</label><input type="text" id="dutch_prob_chance_3"/></div>
                <div><label>4¬™ Odd</label><input type="text" id="dutch_prob_odd_4"/></div>
                <div><label>Probabildade 4 (%)</label><input type="text" id="dutch_prob_chance_4"/></div>
            </div>
            <button onclick="calcularDutchingOtimizado()">Calcular Dutching Otimizado</button>
            <button class="report-action" onclick="adicionarAoRelatorio('dutching_otimizado')">Adicionar ao Relat√≥rio</button>
            <div class="resultado" id="resultado_dutching_otimizado"></div>
        </fieldset>
        <fieldset>
            <legend>Calculadora de Dutching (Valores Individuais)</legend>
             <div class="dutch-grid">
                <div><label>Valor da 1¬™ Aposta</label><input type="text" id="dutch_val_1"/><label>1¬™ Odd</label><input type="text" id="dutch_odd_1"/></div>
                <div><label>Valor da 2¬™ Aposta</label><input type="text" id="dutch_val_2"/><label>2¬™ Odd</label><input type="text" id="dutch_odd_2"/></div>
                <div><label>Valor da 3¬™ Aposta</label><input type="text" id="dutch_val_3"/><label>3¬™ Odd</label><input type="text" id="dutch_odd_3"/></div>
                <div><label>Valor da 4¬™ Aposta</label><input type="text" id="dutch_val_4"/><label>4¬™ Odd</label><input type="text" id="dutch_odd_4"/></div>
                <div><label>Valor da 5¬™ Aposta</label><input type="text" id="dutch_val_5"/><label>5¬™ Odd</label><input type="text" id="dutch_odd_5"/></div>
                <div><label>Valor da 6¬™ Aposta</label><input type="text" id="dutch_val_6"/><label>6¬™ Odd</label><input type="text" id="dutch_odd_6"/></div>
             </div>
            <button onclick="calcularDutchingPorValores()">Calcular Dutching Individual</button>
            <button class="report-action" onclick="adicionarAoRelatorio('dutching_valores')">Adicionar ao Relat√≥rio</button>
            <div class="resultado" id="resultado_dutching_valores"></div>
        </fieldset>
    </div>

    <div id="calculadora-relatorio" class="calculadora-container">
        <h3>Relat√≥rio Consolidado</h3>
        <blockquote style="text-align: center;">Visualize as an√°lises, gere um PDF ou limpe os dados.</blockquote>
        <div id="previewRelatorio"></div>
        <div class="botoes-container" style="justify-content: center;">
            <button onclick="gerarPdfRelatorio()">Gerar e Baixar PDF</button>
            <button class="report-action" onclick="zerarRelatorio()">Zerar Relat√≥rio</button>
        </div>
    </div>


<script>
'use strict';
// ===================================================================================
// SE√á√ÉO 0: ESTADO GLOBAL E FUN√á√ïES AUXILIARES
// ===================================================================================
let relatorioDados = [];

const parseInput = (id) => { 
    const el = document.getElementById(id); 
    if (!el || el.value.trim() === '') return NaN; 
    return parseFloat(String(el.value).replace(',', '.')); 
};

const formatOutput = (n, dec = 2) => { 
    if (isNaN(n) || n === null) return 'N/A'; 
    return n.toFixed(dec).replace('.', ','); 
};

const isChecked = (id) => {
    const el = document.getElementById(id);
    return el ? el.checked : false;
};

const getValue = (id) => {
    const el = document.getElementById(id);
    if (!el) return '';
    if (el.tagName.toLowerCase() === 'select' && el.options[el.selectedIndex]) {
        return el.options[el.selectedIndex].text;
    }
    return el.value;
};

const getSelectValue = (id) => {
    const el = document.getElementById(id);
    return el ? el.value : '';
};

const updateDisplayValue = (id, value, decimals = 1) => {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = formatOutput(value, decimals);
    }
};

// ===================================================================================
// SE√á√ÉO DE DADOS (EXEMPLO PARA PREENCHIMENTO AUTOM√ÅTICO)
// ===================================================================================
const baseDeDados = {
  "Corinthians": { 
    xg_casa_base: 1.55, xga_casa_base: 0.95, xg_fora_base: 1.10, xga_fora_base: 1.40,
    finalizacoes_pro_casa: 14.5, finalizacoes_ced_casa: 10.2, finalizacoes_pro_fora: 11.8, finalizacoes_ced_fora: 13.1,
    sot_pro_casa: 4.5, sot_ced_casa: 3.2, sot_pro_fora: 3.8, sot_ced_fora: 4.1,
    escanteios_pro_casa: 6.2, escanteios_ced_casa: 4.1, escanteios_pro_fora: 5.1, escanteios_ced_fora: 5.5,
    cartoes_media_casa: 2.7, cartoes_media_fora: 3.0,
    faltas_cometidas_em_casa: 14.2, faltas_sofridas_em_casa: 13.5, 
    faltas_cometidas_fora_de_casa: 15.1, faltas_sofridas_fora_de_casa: 12.9
  },
  "Palmeiras": {
    xg_casa_base: 1.95, xga_casa_base: 0.80, xg_fora_base: 1.45, xga_fora_base: 1.15,
    finalizacoes_pro_casa: 16.2, finalizacoes_ced_casa: 9.1, finalizacoes_pro_fora: 13.5, finalizacoes_ced_fora: 10.9,
    sot_pro_casa: 5.8, sot_ced_casa: 2.9, sot_pro_fora: 4.9, sot_ced_fora: 3.5,
    escanteios_pro_casa: 7.1, escanteios_ced_casa: 3.5, escanteios_pro_fora: 6.0, escanteios_ced_fora: 4.8,
    cartoes_media_casa: 2.2, cartoes_media_fora: 2.5,
    faltas_cometidas_em_casa: 12.8, faltas_sofridas_em_casa: 14.1, 
    faltas_cometidas_fora_de_casa: 13.9, faltas_sofridas_fora_de_casa: 14.5
  },
   "Flamengo": {
    xg_casa_base: 2.10, xga_casa_base: 0.75, xg_fora_base: 1.60, xga_fora_base: 1.25,
    finalizacoes_pro_casa: 17.1, finalizacoes_ced_casa: 8.5, finalizacoes_pro_fora: 14.2, finalizacoes_ced_fora: 11.3,
    sot_pro_casa: 6.5, sot_ced_casa: 2.5, sot_pro_fora: 5.2, sot_ced_fora: 3.8,
    escanteios_pro_casa: 7.5, escanteios_ced_casa: 3.0, escanteios_pro_fora: 6.5, escanteios_ced_fora: 4.2,
    cartoes_media_casa: 2.0, cartoes_media_fora: 2.3,
    faltas_cometidas_em_casa: 11.5, faltas_sofridas_em_casa: 15.0, 
    faltas_cometidas_fora_de_casa: 12.8, faltas_sofridas_fora_de_casa: 15.2
  }
};

function preencherDados() {
  const nomeMandante = getSelectValue('ctx_home');
  const nomeVisitante = getSelectValue('ctx_away');

  const dadosMandante = baseDeDados[nomeMandante];
  const dadosVisitante = baseDeDados[nomeVisitante];

  const preencherCampo = (id, valor) => {
    const campo = document.getElementById(id);
    if (campo) campo.value = valor !== undefined && valor !== null ? String(valor) : '';
  };

  const camposMandante = [
    { id: 'gols_xg_proprio_casa', valorKey: 'xg_casa_base' }, { id: 'gols_xga_oponente_casa', valorKey: 'xga_casa_base' },
    { id: 'finalizacoes_pro_casa', valorKey: 'finalizacoes_pro_casa' }, { id: 'finalizacoes_contra_casa', valorKey: 'finalizacoes_ced_casa' },
    { id: 'sot_saves_pro_casa', valorKey: 'sot_pro_casa' }, { id: 'sot_saves_contra_casa', valorKey: 'sot_ced_casa' },
    { id: 'escanteios_pro_casa', valorKey: 'escanteios_pro_casa' }, { id: 'escanteios_contra_casa', valorKey: 'escanteios_ced_casa' },
    { id: 'cartoes_time_casa', valorKey: 'cartoes_media_casa' },
    { id: 'faltas_cometidas_media_casa', valorKey: 'faltas_cometidas_em_casa' }, { id: 'faltas_sofridas_media_casa', valorKey: 'faltas_sofridas_em_casa' },
    { id: 'gols_marcados_casa', valorKey: null }, { id: 'gols_xg_casa', valorKey: null }
  ];

  const camposVisitante = [
    { id: 'gols_xg_proprio_visitante', valorKey: 'xg_fora_base' }, { id: 'gols_xga_oponente_visitante', valorKey: 'xga_fora_base' },
    { id: 'finalizacoes_pro_visitante', valorKey: 'finalizacoes_pro_fora' }, { id: 'finalizacoes_contra_visitante', valorKey: 'finalizacoes_ced_fora' },
    { id: 'sot_saves_pro_visitante', valorKey: 'sot_pro_fora' }, { id: 'sot_saves_contra_visitante', valorKey: 'sot_ced_fora' },
    { id: 'escanteios_pro_visitante', valorKey: 'escanteios_pro_fora' }, { id: 'escanteios_contra_visitante', valorKey: 'escanteios_ced_fora' },
    { id: 'cartoes_time_visitante', valorKey: 'cartoes_media_fora' },
    { id: 'faltas_cometidas_media_visitante', valorKey: 'faltas_cometidas_fora_de_casa' }, { id: 'faltas_sofridas_media_visitante', valorKey: 'faltas_sofridas_fora_de_casa' },
    { id: 'gols_marcados_visitante', valorKey: null }, { id: 'gols_xg_visitante', valorKey: null }
  ];

  camposMandante.forEach(campo => {
      preencherCampo(campo.id, dadosMandante && campo.valorKey ? dadosMandante[campo.valorKey] : '');
  });

  camposVisitante.forEach(campo => {
      preencherCampo(campo.id, dadosVisitante && campo.valorKey ? dadosVisitante[campo.valorKey] : '');
  });
}
// ===================================================================================
// SE√á√ÉO 1: NAVEGA√á√ÉO E RELAT√ìRIO
// ===================================================================================
function showCalculator(id) {
    document.querySelectorAll('.calculadora-container').forEach(d => d.style.display = 'none');
    const container = document.getElementById(`calculadora-${id}`);
    if (container) {
        container.style.display = 'block';
    }
    document.querySelectorAll('#menu button').forEach(b => {
        b.classList.remove('active');
        if (b.getAttribute('onclick') === `showCalculator('${id}')`) b.classList.add('active');
    });
}

function adicionarAoRelatorio(tipo) {
    const resultadoEl = document.getElementById(`resultado_${tipo}`);
    let titulo;

    if (['hedge', 'dutching_total', 'dutching_valores', 'kelly', 'dutching_otimizado'].includes(tipo)) {
        const parentFieldset = resultadoEl.parentElement;
        titulo = parentFieldset.querySelector('legend').innerText;
    } else {
        titulo = document.querySelector(`#calculadora-${tipo} h3`).innerText;
    }

    if (!resultadoEl || !titulo || resultadoEl.style.display === 'none' || resultadoEl.innerText.includes('ERRO') || resultadoEl.innerText.trim() === "") {
        alert('Calcule um resultado v√°lido antes de adicionar ao relat√≥rio.'); return;
    }
    const item = { id: tipo, titulo: titulo, conteudo: resultadoEl.innerText };
    const index = relatorioDados.findIndex(r => r.id === tipo);
    if (index > -1) { relatorioDados[index] = item; } else { relatorioDados.push(item); }
    atualizarPreviewRelatorio();
    alert(`"${item.titulo}" foi adicionado/atualizado no relat√≥rio.`);
}

function atualizarPreviewRelatorio() {
    const previewDiv = document.getElementById('previewRelatorio');
    previewDiv.innerHTML = '';
    if (relatorioDados.length === 0) {
        previewDiv.innerHTML = '<p style="text-align:center; font-style:italic; padding: 20px;">Nenhuma an√°lise adicionada.</p>'; return;
    }
    relatorioDados.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'report-preview-item';
        itemDiv.innerHTML = `<strong>${item.titulo}</strong><div style="padding-top: 5px;">${item.conteudo.replace(/\n/g, '<br>')}</div>`;
        previewDiv.appendChild(itemDiv);
    });
}

function gerarPdfRelatorio() {
    if (relatorioDados.length === 0) {
        alert('O relat√≥rio est√° vazio.');
        return;
    }
    const container = document.createElement('div');
    container.style.position = 'absolute';
    container.style.left = '-9999px';
    container.style.width = '800px';

    const home = getValue('ctx_home');
    const away = getValue('ctx_away');
    const titleText = (home !== 'Selecione o Mandante' && away !== 'Selecione o Visitante') ? `${home} vs ${away}` : 'An√°lise Geral';


    let html = `<div style="font-family: Arial, sans-serif; padding: 20px; color: #333; width: 100%;">`;
    html += `<h1 style="color: #07251F; text-align: center;">Relat√≥rio de An√°lise: ${titleText}</h1><p style="text-align: center; font-size: 12px; color: #666;">Gerado em: ${new Date().toLocaleString('pt-BR')}</p><hr style="border-top: 1px solid #ccc; border-bottom: none;">`;
    
    relatorioDados.forEach(item => {
        const conteudoFormatado = item.conteudo.replace(/\n/g, '<br/>');
        html += `<div style="margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #fdfdfd;">
                    <h3 style="background-color: #f2f2f2; padding: 10px; margin: 0; color: #07251F; border-radius: 8px 8px 0 0; font-size: 16px; border-bottom: 1px solid #ddd;">${item.titulo}</h3>
                    <div style="padding: 12px; font-size: 13px; line-height: 1.6; word-wrap: break-word;">${conteudoFormatado}</div>
                </div>`;
    });
    html += `</div>`;
    container.innerHTML = html;
    document.body.appendChild(container);

    setTimeout(() => {
        const options = {
            margin: 0.5,
            filename: 'relatorio_analise_preditiva.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().from(container).set(options).save().then(() => {
            document.body.removeChild(container);
        }).catch(err => {
            console.error("Erro ao gerar PDF:", err);
            document.body.removeChild(container);
        });
    }, 300);
}

function zerarRelatorio() {
    if (confirm('Tem certeza que deseja limpar todos os dados do relat√≥rio?')) {
        relatorioDados = [];
        atualizarPreviewRelatorio();
        alert('Relat√≥rio zerado.');
    }
}

// ===================================================================================
// SE√á√ÉO 2: L√ìGICA DAS CALCULADORAS PREDITIVAS
// ===================================================================================

function getContextualFactors(calculationType = 'default', baseStrengthHome = 1, baseStrengthAway = 1) {
    let fatorCasa = 1.0, fatorVisitante = 1.0;
    const analyticalBias = getSelectValue('ctx_analytical_bias'); 

    let homeIsFavorite = baseStrengthHome > baseStrengthAway;
    let awayIsFavorite = baseStrengthAway > baseStrengthHome;
    if (Math.abs(baseStrengthHome - baseStrengthAway) < 0.01) { 
        homeIsFavorite = false; 
        awayIsFavorite = false;
    }

    const attendance = getSelectValue('ctx_stadium_attendance');
    const isAltitude = isChecked('ctx_altitude');
    const isBadWeather = isChecked('ctx_bad_weather');
    const isDerby = isChecked('ctx_derby');
    const refereeStyle = getSelectValue('ctx_referee_style');
    
    const homeShortRest = isChecked('ctx_home_short_rest');
    const homeMustWin = isChecked('ctx_home_must_win');
    const homeNewManager = isChecked('ctx_home_new_manager');
    const homeFocoOutroJogo = isChecked('ctx_home_foco_outro_jogo');
    const homeNoMotivation = isChecked('ctx_home_no_motivation');
    const homeAttackAbsences = isChecked('ctx_home_attack_absences');
    const homeDefenseAbsences = isChecked('ctx_home_defense_absences');

    const awayShortRest = isChecked('ctx_away_short_rest');
    const awayLongTravel = isChecked('ctx_away_long_travel');
    const awayMustWin = isChecked('ctx_away_must_win');
    const awayNewManager = isChecked('ctx_away_new_manager');
    const awayFocoOutroJogo = isChecked('ctx_away_foco_outro_jogo');
    const awayNoMotivation = isChecked('ctx_away_no_motivation');
    const awayAttackAbsences = isChecked('ctx_away_attack_absences');
    const awayDefenseAbsences = isChecked('ctx_away_defense_absences');

    const MULTIPLIERS = {
        ATTENDANCE_FULL_HOME: 1.05, ATTENDANCE_FULL_AWAY: 0.97,
        ATTENDANCE_EMPTY_HOME: 0.95, ATTENDANCE_EMPTY_AWAY: 1.03,
        ALTITUDE_HOME: 1.08, ALTITUDE_AWAY: 0.92,
        BAD_WEATHER: 0.90,
        DERBY_OFFENSE: 0.70, DERBY_DISCIPLINE: 1.30,
        SHORT_REST: 0.95, LONG_TRAVEL_AWAY: 0.96,
        NEW_MANAGER: 1.05,
        FOCO_OUTRO_JOGO_SELF: 0.82, FOCO_OUTRO_JOGO_OPP: 1.10,
        ATTACK_ABSENCES_SELF: 0.88, DEFENSE_ABSENCES_OPP: 1.10,
        NO_MOTIVATION_SELF: 0.90,
        MUST_WIN_SELF: 1.08,
        BIAS_ARROJADO_FAV: 1.15, BIAS_ARROJADO_UND: 0.85, BIAS_ARROJADO_NEUTRAL_BOTH: 1.05,
        BIAS_CONSERVADOR_FAV: 0.85, BIAS_CONSERVADOR_UND: 0.95, BIAS_CONSERVADOR_NEUTRAL_BOTH: 0.90,
        DISCIPLINE_ATTENDANCE_FULL_HOME: 0.95, DISCIPLINE_ATTENDANCE_FULL_AWAY: 1.10,
        DISCIPLINE_BAD_WEATHER: 1.10,
        REFEREE_RIGID: 1.20, REFEREE_PERMISSIVE: 0.85,
        BIAS_ARROJADO_DISCIPLINE_UND: 1.10, BIAS_ARROJADO_DISCIPLINE_NEUTRAL_BOTH: 1.05,
        BIAS_CONSERVADOR_DISCIPLINE_BOTH: 0.90
    };

    if (['gols', 'sot_saves', 'finalizacoes', 'escanteios'].includes(calculationType)) {
        if (attendance === 'lotado') { fatorCasa *= MULTIPLIERS.ATTENDANCE_FULL_HOME; fatorVisitante *= MULTIPLIERS.ATTENDANCE_FULL_AWAY; }
        if (attendance === 'vazio') { fatorCasa *= MULTIPLIERS.ATTENDANCE_EMPTY_HOME; fatorVisitante *= MULTIPLIERS.ATTENDANCE_EMPTY_AWAY; }
        if (isAltitude) { fatorCasa *= MULTIPLIERS.ALTITUDE_HOME; fatorVisitante *= MULTIPLIERS.ALTITUDE_AWAY; }
        if (isBadWeather) { fatorCasa *= MULTIPLIERS.BAD_WEATHER; fatorVisitante *= MULTIPLIERS.BAD_WEATHER; }
        if (isDerby) { fatorCasa *= MULTIPLIERS.DERBY_OFFENSE; fatorVisitante *= MULTIPLIERS.DERBY_OFFENSE; } 
        
        if (homeShortRest) fatorCasa *= MULTIPLIERS.SHORT_REST;
        if (awayShortRest) fatorVisitante *= MULTIPLIERS.SHORT_REST;
        if (awayLongTravel) fatorVisitante *= MULTIPLIERS.LONG_TRAVEL_AWAY;
        if (homeNewManager) fatorCasa *= MULTIPLIERS.NEW_MANAGER;
        if (awayNewManager) fatorVisitante *= MULTIPLIERS.NEW_MANAGER;
        
        if (homeFocoOutroJogo) { fatorCasa *= MULTIPLIERS.FOCO_OUTRO_JOGO_SELF; fatorVisitante *= MULTIPLIERS.FOCO_OUTRO_JOGO_OPP;
        } else {
            if (homeAttackAbsences) fatorCasa *= MULTIPLIERS.ATTACK_ABSENCES_SELF;
            if (homeDefenseAbsences) fatorVisitante *= MULTIPLIERS.DEFENSE_ABSENCES_OPP;
            if (homeNoMotivation) fatorCasa *= MULTIPLIERS.NO_MOTIVATION_SELF;
        }
        if (awayFocoOutroJogo) { fatorVisitante *= MULTIPLIERS.FOCO_OUTRO_JOGO_SELF; fatorCasa *= MULTIPLIERS.FOCO_OUTRO_JOGO_OPP;
        } else {
            if (awayAttackAbsences) fatorVisitante *= MULTIPLIERS.ATTACK_ABSENCES_SELF;
            if (awayDefenseAbsences) fatorCasa *= MULTIPLIERS.DEFENSE_ABSENCES_OPP;
            if (awayNoMotivation) fatorVisitante *= MULTIPLIERS.NO_MOTIVATION_SELF;
        }
        
        if (homeMustWin) fatorCasa *= MULTIPLIERS.MUST_WIN_SELF;
        if (awayMustWin) fatorVisitante *= MULTIPLIERS.MUST_WIN_SELF;

        if (analyticalBias === 'arrojado') {
            if (homeIsFavorite) { fatorCasa *= MULTIPLIERS.BIAS_ARROJADO_FAV; fatorVisitante *= MULTIPLIERS.BIAS_ARROJADO_UND;
            } else if (awayIsFavorite) { fatorCasa *= MULTIPLIERS.BIAS_ARROJADO_UND; fatorVisitante *= MULTIPLIERS.BIAS_ARROJADO_FAV;
            } else { fatorCasa *= MULTIPLIERS.BIAS_ARROJADO_NEUTRAL_BOTH; fatorVisitante *= MULTIPLIERS.BIAS_ARROJADO_NEUTRAL_BOTH;}
        } else if (analyticalBias === 'conservador') {
            if (homeIsFavorite) { fatorCasa *= MULTIPLIERS.BIAS_CONSERVADOR_FAV; fatorVisitante *= MULTIPLIERS.BIAS_CONSERVADOR_UND;
            } else if (awayIsFavorite) { fatorCasa *= MULTIPLIERS.BIAS_CONSERVADOR_UND; fatorVisitante *= MULTIPLIERS.BIAS_CONSERVADOR_FAV;
            } else { fatorCasa *= MULTIPLIERS.BIAS_CONSERVADOR_NEUTRAL_BOTH; fatorVisitante *= MULTIPLIERS.BIAS_CONSERVADOR_NEUTRAL_BOTH; }
        }

    } else if (['cartoes', 'faltas'].includes(calculationType)) {
        if (attendance === 'lotado') { fatorCasa *= MULTIPLIERS.DISCIPLINE_ATTENDANCE_FULL_HOME; fatorVisitante *= MULTIPLIERS.DISCIPLINE_ATTENDANCE_FULL_AWAY; }
        if (isBadWeather) { fatorCasa *= MULTIPLIERS.DISCIPLINE_BAD_WEATHER; fatorVisitante *= MULTIPLIERS.DISCIPLINE_BAD_WEATHER; }
        if (isDerby) { fatorCasa *= MULTIPLIERS.DERBY_DISCIPLINE; fatorVisitante *= MULTIPLIERS.DERBY_DISCIPLINE; } 
        if (refereeStyle === 'rigido') { fatorCasa *= MULTIPLIERS.REFEREE_RIGID; fatorVisitante *= MULTIPLIERS.REFEREE_RIGID; }
        if (refereeStyle === 'permissivo') { fatorCasa *= MULTIPLIERS.REFEREE_PERMISSIVE; fatorVisitante *= MULTIPLIERS.REFEREE_PERMISSIVE; }

        if (analyticalBias === 'arrojado') {
            if (homeIsFavorite) { fatorVisitante *= MULTIPLIERS.BIAS_ARROJADO_DISCIPLINE_UND;
            } else if (awayIsFavorite) { fatorCasa *= MULTIPLIERS.BIAS_ARROJADO_DISCIPLINE_UND;
            } else { fatorCasa *= MULTIPLIERS.BIAS_ARROJADO_DISCIPLINE_NEUTRAL_BOTH; fatorVisitante *= MULTIPLIERS.BIAS_ARROJADO_DISCIPLINE_NEUTRAL_BOTH; }
        } else if (analyticalBias === 'conservador') {
            fatorCasa *= MULTIPLIERS.BIAS_CONSERVADOR_DISCIPLINE_BOTH;
            fatorVisitante *= MULTIPLIERS.BIAS_CONSERVADOR_DISCIPLINE_BOTH;
        }
    }
    return { fatorCasa, fatorVisitante };
}

function calcularDixonColes() {
    const xgProprioCasaInp = parseInput('gols_xg_proprio_casa');
    const xgaOponenteVisitanteInp = parseInput('gols_xga_oponente_visitante');
    const xgProprioVisitanteInp = parseInput('gols_xg_proprio_visitante');
    const xgaOponenteCasaInp = parseInput('gols_xga_oponente_casa');
    
    const rd = document.getElementById('resultado_gols');
    if (isNaN(xgProprioCasaInp) || isNaN(xgaOponenteVisitanteInp) || isNaN(xgProprioVisitanteInp) || isNaN(xgaOponenteCasaInp)) {
        rd.innerText = 'ERRO: Preencha os campos de xG Pr√≥prio e xGA do Oponente.'; rd.style.display = 'block'; return;
    }

    let baseStrengthHome = (xgProprioCasaInp + xgaOponenteVisitanteInp) / 2;
    let baseStrengthAway = (xgProprioVisitanteInp + xgaOponenteCasaInp) / 2;
    
    let lCasaPonderado = baseStrengthHome;
    let lVisPonderado = baseStrengthAway;

    const xgH2HCasa = parseInput('gols_xg_h2h_casa');
    const xgaH2HVisitante = parseInput('gols_xga_h2h_visitante');
    const xgH2HVisitanteInp = parseInput('gols_xg_h2h_visitante'); 
    const xgaH2HCasaInp = parseInput('gols_xga_h2h_casa'); 

    const H2H_WEIGHT_GENERAL_GOALS = 0.70;
    const H2H_WEIGHT_SPECIFIC_GOALS = 0.30;

    if (!isNaN(xgH2HCasa) && !isNaN(xgaH2HVisitante) && !isNaN(xgH2HVisitanteInp) && !isNaN(xgaH2HCasaInp)) {
        const lambdaH2HCasaMatch = (xgH2HCasa + xgaH2HVisitante) / 2;
        const lambdaH2HVisitanteMatch = (xgH2HVisitanteInp + xgaH2HCasaInp) / 2;
        lCasaPonderado = (lCasaPonderado * H2H_WEIGHT_GENERAL_GOALS) + (lambdaH2HCasaMatch * H2H_WEIGHT_SPECIFIC_GOALS); 
        lVisPonderado = (lVisPonderado * H2H_WEIGHT_GENERAL_GOALS) + (lambdaH2HVisitanteMatch * H2H_WEIGHT_SPECIFIC_GOALS); 
    }

    const golsMarcadosCasa = parseInput('gols_marcados_casa');
    const xgAcumuladoCasa = parseInput('gols_xg_casa');
    if (!isNaN(golsMarcadosCasa) && !isNaN(xgAcumuladoCasa) && xgAcumuladoCasa > 0) {
        lCasaPonderado *= (golsMarcadosCasa / xgAcumuladoCasa);
    }

    const golsMarcadosVisitante = parseInput('gols_marcados_visitante');
    const xgAcumuladoVisitante = parseInput('gols_xg_visitante');
    if (!isNaN(golsMarcadosVisitante) && !isNaN(xgAcumuladoVisitante) && xgAcumuladoVisitante > 0) {
        lVisPonderado *= (golsMarcadosVisitante / xgAcumuladoVisitante);
    }

    const { fatorCasa, fatorVisitante } = getContextualFactors('gols', baseStrengthHome, baseStrengthAway);
    
    const lCasaFinal = Math.max(0.01, lCasaPonderado * fatorCasa);
    const lVisFinal = Math.max(0.01, lVisPonderado * fatorVisitante);
    
    updateDisplayValue('displayLambdaCasa', lCasaFinal, 3);
    updateDisplayValue('displayLambdaVisitante', lVisFinal, 3);

    let probCasa = 0, probEmpate = 0, probVis = 0, over25 = 0;
    const placares = [];
    const factorialCache = {}; 
    const factorial = (n) => {
        if (n < 0) return Infinity;
        if (n <= 1) return 1;
        if (factorialCache[n]) return factorialCache[n];
        factorialCache[n] = n * factorial(n - 1);
        return factorialCache[n];
    };
    const poisson = (k, lambda) => (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
    
    const MAX_GOALS_ITERATION = 7;
    for (let i = 0; i <= MAX_GOALS_ITERATION; i++) { 
        for (let j = 0; j <= MAX_GOALS_ITERATION; j++) {
            const prob = poisson(i, lCasaFinal) * poisson(j, lVisFinal);
            if (prob > 0.00001) placares.push({ score: `${i}-${j}`, probability: prob }); 
            if (i > j) probCasa += prob; else if (j > i) probVis += prob; else probEmpate += prob;
        }
    }
    
    let totalProbSum = probCasa + probEmpate + probVis;
     if (totalProbSum === 0) { 
        rd.innerText = 'ERRO: Proje√ß√µes de gols muito baixas para calcular probabilidades. Verifique os inputs.';
        rd.style.display = 'block';
        return;
    }

    if (Math.abs(totalProbSum - 1.0) > 0.0001) { 
        const normFactor = 1.0 / totalProbSum;
        probCasa *= normFactor;
        probEmpate *= normFactor;
        probVis *= normFactor;
        placares.forEach(p => p.probability *= normFactor);
    }
    
    over25 = 0;
    placares.forEach(p => {
        const scores = p.score.split('-').map(Number);
        if (scores[0] + scores[1] > 2.5) {
            over25 += p.probability;
        }
    });

    placares.sort((a, b) => b.probability - a.probability);
    const placaresTxt = placares.slice(0, 5).map((p, i) => `${i+1}¬∫: ${p.score} (${formatOutput(p.probability * 100, 1)}%)`).join('\n');

    let texto = `--- PROBABILIDADES DE RESULTADO (1X2) ---\n`;
    texto += `Vit√≥ria Mandante: ${formatOutput(probCasa * 100)}%\n`;
    texto += `Empate: ${formatOutput(probEmpate * 100)}%\n`;
    texto += `Vit√≥ria Visitante: ${formatOutput(probVis * 100)}%\n\n`;
    texto += `--- MERCADO DE GOLS (Mais/Menos 2.5) ---\n`;
    texto += `Mais de 2.5: ${formatOutput(over25 * 100)}%\n`;
    texto += `Menos de 2.5: ${formatOutput(Math.max(0, (1 - over25)) * 100)}%\n\n`;
    texto += `--- TOP 5 PLACARES MAIS PROV√ÅVEIS ---\n${placaresTxt}`;
    rd.innerText = texto;
    rd.style.display = 'block';
}

function calcularProjecaoSimples(prefix, calculationType) {
    const proCasaInp = parseInput(`${prefix}_pro_casa`);
    const contraVisInp = parseInput(`${prefix}_contra_visitante`);
    const proVisInp = parseInput(`${prefix}_pro_visitante`);
    const contraCasaInp = parseInput(`${prefix}_contra_casa`);
    const rd = document.getElementById(`resultado_${prefix}`);

    if (isNaN(proCasaInp) || isNaN(contraVisInp) || isNaN(proVisInp) || isNaN(contraCasaInp)) {
        rd.innerText = 'ERRO: Preencha todos os 4 campos de performance base.'; rd.style.display = 'block'; return { error: true, projCasaFinal: NaN, projVisFinal: NaN };
    }
    
    const baseStrengthHome = (proCasaInp + contraVisInp) / 2;
    const baseStrengthAway = (proVisInp + contraCasaInp) / 2;

    const { fatorCasa, fatorVisitante } = getContextualFactors(calculationType, baseStrengthHome, baseStrengthAway);
    
    const projCasaFinal = baseStrengthHome * fatorCasa;
    const projVisFinal = baseStrengthAway * fatorVisitante;

    return { projCasaFinal: Math.max(0, projCasaFinal), projVisFinal: Math.max(0, projVisFinal), rd, error: false };
}

function calcularFaltas() {
    const rd = document.getElementById('resultado_faltas');
    const mediaArbitroCalc = parseInput('faltas_media_arbitro');
    const mediaArbitroCtx = parseInput('ctx_referee_fouls');
    let mediaArbitro = isNaN(mediaArbitroCalc) ? mediaArbitroCtx : mediaArbitroCalc;
    
    if (isNaN(mediaArbitro)) {
        rd.innerText = 'ERRO: M√©dia de Faltas do √Årbitro deve ser preenchida.'; rd.style.display = 'block'; return;
    }
    mediaArbitro = Math.max(0, mediaArbitro);

    const mediaCometidasMandanteEmCasa = parseInput('faltas_cometidas_media_casa');
    const mediaSofridasPeloVisitanteFora = parseInput('faltas_sofridas_media_visitante');
    const mediaCometidasVisitanteFora = parseInput('faltas_cometidas_media_visitante');
    const mediaSofridasPeloMandanteEmCasa = parseInput('faltas_sofridas_media_casa');
    
    if (isNaN(mediaCometidasMandanteEmCasa) || isNaN(mediaSofridasPeloVisitanteFora) || isNaN(mediaCometidasVisitanteFora) || isNaN(mediaSofridasPeloMandanteEmCasa)) {
        rd.innerText = 'ERRO: Preencha todos os campos de M√©dia de Faltas (espec√≠ficos de mando).'; rd.style.display = 'block'; return;
    }
    
    let propensaoFaltasMandante = (mediaCometidasMandanteEmCasa + mediaSofridasPeloVisitanteFora) / 2;
    let propensaoFaltasVisitante = (mediaCometidasVisitanteFora + mediaSofridasPeloMandanteEmCasa) / 2;

    const h2hCometidasMandante = parseInput('faltas_cometidas_h2h_casa'); 
    const h2hCometidasVisitanteInp = parseInput('faltas_cometidas_h2h_visitante'); 
        
    const H2H_WEIGHT_GENERAL_DISCIPLINE = 0.70;
    const H2H_WEIGHT_SPECIFIC_DISCIPLINE = 0.30;

    if (!isNaN(h2hCometidasMandante)) {
        propensaoFaltasMandante = (propensaoFaltasMandante * H2H_WEIGHT_GENERAL_DISCIPLINE) + (h2hCometidasMandante * H2H_WEIGHT_SPECIFIC_DISCIPLINE);
    }
    if (!isNaN(h2hCometidasVisitanteInp)) {
        propensaoFaltasVisitante = (propensaoFaltasVisitante * H2H_WEIGHT_GENERAL_DISCIPLINE) + (h2hCometidasVisitanteInp * H2H_WEIGHT_SPECIFIC_DISCIPLINE);
    }

    const ARBITRO_WEIGHT_PROPENSAO = 0.6;
    const ARBITRO_WEIGHT_MEDIA = 0.4;

    let baseStrengthHomeFouls = (propensaoFaltasMandante * ARBITRO_WEIGHT_PROPENSAO) + (mediaArbitro * ARBITRO_WEIGHT_MEDIA);
    let baseStrengthAwayFouls = (propensaoFaltasVisitante * ARBITRO_WEIGHT_PROPENSAO) + (mediaArbitro * ARBITRO_WEIGHT_MEDIA);
    
    const { fatorCasa, fatorVisitante } = getContextualFactors('faltas', baseStrengthHomeFouls, baseStrengthAwayFouls);
    const faltasCasaFinal = Math.max(0, baseStrengthHomeFouls * fatorCasa);
    const faltasVisFinal = Math.max(0, baseStrengthAwayFouls * fatorVisitante);

    updateDisplayValue('displayFaltasCasa', faltasCasaFinal, 1);
    updateDisplayValue('displayFaltasVisitante', faltasVisFinal, 1);

    let texto = `--- PROJE√á√ÉO DE FALTAS ---\n`;
    texto += `Faltas Cometidas (Mandante): ${formatOutput(faltasCasaFinal, 1)}\n`;
    texto += `Faltas Cometidas (Visitante): ${formatOutput(faltasVisFinal, 1)}\n\n`;
    texto += `--- TOTAIS DA PARTIDA ---\n`;
    texto += `Total de Faltas na Partida: ${formatOutput(faltasCasaFinal + faltasVisFinal, 1)}`;
    rd.innerText = texto;
    rd.style.display = 'block';
}

function calcularCartoes() {
    const rd = document.getElementById('resultado_cartoes');
    const mediaArbitroCalc = parseInput('cartoes_media_arbitro');
    const mediaArbitroCtx = parseInput('ctx_referee_cards');
    let mediaArbitro = isNaN(mediaArbitroCalc) ? mediaArbitroCtx : mediaArbitroCalc;

    if (isNaN(mediaArbitro)) {
        rd.innerText = 'ERRO: M√©dia de Cart√µes do √Årbitro deve ser preenchida.'; rd.style.display = 'block'; return;
    }
    mediaArbitro = Math.max(0, mediaArbitro);

    let pCasaTime = parseInput('cartoes_time_casa'); 
    let pVisTime = parseInput('cartoes_time_visitante'); 
    const h2hCasa = parseInput('cartoes_h2h_casa');
    const h2hVis = parseInput('cartoes_h2h_visitante');

    if (isNaN(pCasaTime) || isNaN(pVisTime)) {
        rd.innerText = 'ERRO: Preencha as M√©dias de Cart√µes dos participantes.'; rd.style.display = 'block'; return;
    }

    const ARBITRO_WEIGHT_PROPENSAO = 0.6;
    const ARBITRO_WEIGHT_MEDIA = 0.4;
    const H2H_WEIGHT_GENERAL_DISCIPLINE = 0.70;
    const H2H_WEIGHT_SPECIFIC_DISCIPLINE = 0.30;

    let baseStrengthHomeCards = (pCasaTime * ARBITRO_WEIGHT_PROPENSAO) + (mediaArbitro * ARBITRO_WEIGHT_MEDIA);
    let baseStrengthAwayCards = (pVisTime * ARBITRO_WEIGHT_PROPENSAO) + (mediaArbitro * ARBITRO_WEIGHT_MEDIA);

    if (!isNaN(h2hCasa) && !isNaN(h2hVis)) { 
        baseStrengthHomeCards = (baseStrengthHomeCards * H2H_WEIGHT_GENERAL_DISCIPLINE) + (h2hCasa * H2H_WEIGHT_SPECIFIC_DISCIPLINE);
        baseStrengthAwayCards = (baseStrengthAwayCards * H2H_WEIGHT_GENERAL_DISCIPLINE) + (h2hVis * H2H_WEIGHT_SPECIFIC_DISCIPLINE);
    }
    
    const { fatorCasa, fatorVisitante } = getContextualFactors('cartoes', baseStrengthHomeCards, baseStrengthAwayCards);
    let pCasaFinal = Math.max(0, baseStrengthHomeCards * fatorCasa);
    let pVisFinal = Math.max(0, baseStrengthAwayCards * fatorVisitante);

    updateDisplayValue('displayCartCasa', pCasaFinal, 1);
    updateDisplayValue('displayCartVisitante', pVisFinal, 1);

    let texto = `--- PROJE√á√ÉO DE CART√ïES ---\n`;
    texto += `Cart√µes (Mandante): ${formatOutput(pCasaFinal, 1)}\n`;
    texto += `Cart√µes (Visitante): ${formatOutput(pVisFinal, 1)}\n\n`;
    texto += `--- TOTAIS DA PARTIDA ---\n`;
    texto += `Total de Cart√µes na Partida: ${formatOutput(pCasaFinal + pVisFinal, 1)}`;
    rd.innerText = texto;
    rd.style.display = 'block';
}

function calcularSoTSaves() {
    const { projCasaFinal, projVisFinal, rd, error } = calcularProjecaoSimples('sot_saves', 'sot_saves');
    if (error) return; 

    updateDisplayValue('displaySotCasa', projCasaFinal, 1);
    updateDisplayValue('displaySotVisitante', projVisFinal, 1);
    
    let texto = `--- PROJE√á√ÉO POR PARTICIPANTE ---\n`;
    texto += `Finaliza√ß√µes no Gol (Mandante): ${formatOutput(projCasaFinal, 1)}\n`;
    texto += `Finaliza√ß√µes no Gol (Visitante): ${formatOutput(projVisFinal, 1)}\n\n`;
    texto += `--- TOTAIS DA PARTIDA ---\n`;
    texto += `Total de Finaliza√ß√µes no Gol: ${formatOutput(projCasaFinal + projVisFinal, 1)}`;

    const gkSavePctCasa = parseInput('sot_saves_gk_savepct_casa');
    const gkSavePctVisitante = parseInput('sot_saves_gk_savepct_visitante');

    if (!isNaN(gkSavePctCasa) && !isNaN(gkSavePctVisitante) && projVisFinal > 0 && projCasaFinal > 0) {
        const defesasCasa = projVisFinal * (gkSavePctCasa / 100);
        const defesasVisitante = projCasaFinal * (gkSavePctVisitante / 100);
        texto += `\n\n--- AN√ÅLISE DE GOLEIROS (OPCIONAL) ---\n`;
        texto += `Defesas Esperadas (Goleiro Mandante): ${formatOutput(defesasCasa, 1)}\n`;
        texto += `Defesas Esperadas (Goleiro Visitante): ${formatOutput(defesasVisitante, 1)}`;
    }
    rd.innerText = texto;
    rd.style.display = 'block';
}

function calcularFinalizacoes() {
    const { projCasaFinal, projVisFinal, rd, error } = calcularProjecaoSimples('finalizacoes', 'finalizacoes');
    if (error) return;

    updateDisplayValue('displayFinCasa', projCasaFinal, 1);
    updateDisplayValue('displayFinVisitante', projVisFinal, 1);

    let texto = `--- PROJE√á√ÉO POR PARTICIPANTE ---\n`;
    texto += `Total de Finaliza√ß√µes (Mandante): ${formatOutput(projCasaFinal, 1)}\n`;
    texto += `Total de Finaliza√ß√µes (Visitante): ${formatOutput(projVisFinal, 1)}\n\n`;
    texto += `--- TOTAIS DA PARTIDA ---\n`;
    texto += `Total de Finaliza√ß√µes na Partida: ${formatOutput(projCasaFinal + projVisFinal, 1)}`;
    rd.innerText = texto;
    rd.style.display = 'block';
}

function calcularEscanteios() {
    const { projCasaFinal, projVisFinal, rd, error } = calcularProjecaoSimples('escanteios', 'escanteios');
    if (error) return;
    
    updateDisplayValue('displayEscCasa', projCasaFinal, 1);
    updateDisplayValue('displayEscVisitante', projVisFinal, 1);

    let texto = `--- PROJE√á√ÉO POR PARTICIPANTE ---\n`;
    texto += `Escanteios (Mandante): ${formatOutput(projCasaFinal, 1)}\n`;
    texto += `Escanteios (Visitante): ${formatOutput(projVisFinal, 1)}\n\n`;
    texto += `--- TOTAIS DA PARTIDA ---\n`;
    texto += `Total de Escanteios na Partida: ${formatOutput(projCasaFinal + projVisFinal, 1)}`;
    rd.innerText = texto;
    rd.style.display = 'block';
}

// ===================================================================================
// SE√á√ÉO 3: CALCULADORAS DE GEST√ÉO
// ===================================================================================
function calcularKelly() {
    const banca = parseInput('kelly_banca');
    const odd = parseInput('kelly_odd');
    const probPercent = parseInput('kelly_prob');
    const fatorKelly = parseInput('kelly_fator'); 
    const rd = document.getElementById('resultado_kelly');

    if (isNaN(banca) || isNaN(odd) || isNaN(probPercent) || isNaN(fatorKelly) || odd <= 1 || probPercent < 0 || probPercent > 100 || banca <= 0) { 
        rd.innerText = 'ERRO: Preencha todos os campos com valores v√°lidos (Odd > 1, Prob. 0-100%, Banca > 0).'; 
        rd.style.display = 'block'; 
        return;
    }
    const prob = probPercent / 100; 
    const ev = (odd * prob) - 1; 

    if (prob === 0 || ev <= 0) { 
        rd.innerText = `--- APOSTA SEM VALOR (EV ‚â§ 0 ou Prob. = 0) ---\n\nO Valor Esperado √© de ${formatOutput(ev*100)}%.\n\nN√£o √© recomendado apostar.`;
        rd.style.display = 'block'; return;
    }
    
    const bDecimal = odd - 1; 
    if (bDecimal === 0) { 
        rd.innerText = 'ERRO: Odd inv√°lida para c√°lculo de Kelly (Odd - 1 = 0).';
        rd.style.display = 'block'; return;
    }
    const kellyFraction = (prob * bDecimal - (1 - prob)) / bDecimal;

    if (kellyFraction <= 0) { 
         rd.innerText = `--- APOSTA SEM VALOR (KELLY ‚â§ 0) ---\n\nFra√ß√£o Kelly: ${formatOutput(kellyFraction * 100, 2)}%\nO Valor Esperado √© de ${formatOutput(ev*100)}%.\n\nCrit√©rio de Kelly sugere n√£o apostar.`;
        rd.style.display = 'block'; return;
    }
    const stakeFraction = kellyFraction * fatorKelly;
    const valorUnidade = banca * stakeFraction;

    let texto = `--- C√ÅLCULO DE UNIDADE (KELLY) ---\n\n`;
    texto += `Fra√ß√£o da Banca (Full Kelly): ${formatOutput(kellyFraction * 100, 2)}%\n`;
    texto += `Fra√ß√£o com Fator de Risco (${fatorKelly*100}% Kelly): ${formatOutput(stakeFraction * 100, 2)}%\n\n`;
    texto += `Unidade/Stake Recomendada: R$ ${formatOutput(valorUnidade)}\n`;
    texto += `Lucro Potencial (com esta stake): R$ ${formatOutput(valorUnidade * (odd - 1))}`;
    rd.innerText = texto; rd.style.display = 'block';
}

function calcularHedge(isFechamento = false) {
    const valor1 = parseInput('hedge_valor1');
    const odd1 = parseInput('hedge_odd1');
    const odd2 = parseInput('hedge_odd2');
    let valor2Manual = parseInput('hedge_valor2');
    const rd = document.getElementById('resultado_hedge');

    if (isNaN(valor1) || isNaN(odd1) || isNaN(odd2) || odd1 <= 1 || odd2 <= 1 || valor1 <=0 ) {
        rd.innerText = 'ERRO: Preencha valor da 1¬™ aposta (>0) e as duas odds (>1).'; 
        rd.style.display = 'block'; 
        return;
    }

    let valor2;
    let tituloSecao;

    if (isFechamento) {
        tituloSecao = "--- FECHAMENTO DE POSI√á√ÉO (LUCRO/PERDA GARANTIDO) ---";
        valor2 = (valor1 * odd1) / odd2; 
        document.getElementById('hedge_valor2').value = formatOutput(valor2);
    } else {
        tituloSecao = "--- C√ÅLCULO DE COBERTURA (HEDGE) ---";
        if (!isNaN(valor2Manual) && valor2Manual >= 0) {
            valor2 = valor2Manual;
        } else {
             valor2 = (valor1 * odd1) / (odd1 + odd2); 
             if (valor2 < 0) valor2 = 0; 
        }
    }
    
    const totalInvestido = valor1 + valor2;
    const retornoSeOdd1Vencer = valor1 * odd1;
    const retornoSeOdd2Vencer = valor2 * odd2;
    const lucroSeOdd1Vencer = retornoSeOdd1Vencer - totalInvestido;
    const lucroSeOdd2Vencer = retornoSeOdd2Vencer - totalInvestido;
    
    const oddEfetiva1 = totalInvestido > 0 ? retornoSeOdd1Vencer / totalInvestido : 0;
    const oddEfetiva2 = totalInvestido > 0 ? retornoSeOdd2Vencer / totalInvestido : 0;

    let texto = `${tituloSecao}\n\n`;
    texto += `Aposta 1: R$ ${formatOutput(valor1)} @ ${formatOutput(odd1)}\n`;
    texto += `  ‚Ü≥ Retorno se vencer: R$ ${formatOutput(retornoSeOdd1Vencer)}\n`;
    texto += `  ‚Ü≥ Lucro/Preju√≠zo se vencer (considerando ambas as stakes): R$ ${formatOutput(lucroSeOdd1Vencer)}\n\n`;
    texto += `Aposta 2 (Cobertura): R$ ${formatOutput(valor2)} @ ${formatOutput(odd2)}\n`;
    texto += `  ‚Ü≥ Retorno se vencer: R$ ${formatOutput(retornoSeOdd2Vencer)}\n`;
    texto += `  ‚Ü≥ Lucro/Preju√≠zo se vencer (considerando ambas as stakes): R$ ${formatOutput(lucroSeOdd2Vencer)}\n\n`;
    texto += `Total Investido: R$ ${formatOutput(totalInvestido)}\n`;

    if (isFechamento) {
        texto += `Retorno Garantido (aproximado, se uma das duas vencer): R$ ${formatOutput(retornoSeOdd1Vencer)}\n`;
        texto += `Lucro/Preju√≠zo Garantido (aproximado): R$ ${formatOutput(lucroSeOdd1Vencer)}\n`;
        if (totalInvestido > 0) texto += `Odd Efetiva da Opera√ß√£o: ${formatOutput(oddEfetiva1)}\n`;
    } else {
         if (lucroSeOdd1Vencer < 0 && lucroSeOdd2Vencer < 0) {
            texto += `\nAVISO: Ambas as configura√ß√µes resultam em preju√≠zo.`;
        } else if (Math.abs(lucroSeOdd1Vencer - lucroSeOdd2Vencer) > 0.01 && isNaN(valor2Manual)) {
            texto += `\nNota: Lucros diferentes. Para lucros iguais, ajuste o valor da 2¬™ aposta ou use "Fechar Posi√ß√£o".`;
        }
    }
    rd.innerText = texto; rd.style.display = 'block';
}

function fecharPosicao() {
    calcularHedge(true);
}

function calcularDutchingPorTotal() {
    const total = parseInput('dutch_total_valor');
    const rd = document.getElementById('resultado_dutching_total');
    const odds = [];
    for(let i = 1; i <= 4; i++) {
        const oddInput = parseInput(`dutch_total_odd${i}`);
        if(!isNaN(oddInput) && oddInput > 1) odds.push(oddInput);
    }
    if (isNaN(total) || total <= 0 || odds.length === 0) {
        rd.innerText = 'ERRO: Preencha valor total (>0) e ao menos uma odd v√°lida (>1).'; rd.style.display = 'block'; return;
    }
    const somaInversa = odds.reduce((acc, o) => acc + (1 / o), 0);
    if (somaInversa === 0) { 
         rd.innerText = 'ERRO: Soma das inversas das odds √© zero. Verifique as odds.'; rd.style.display = 'block'; return;
    }
    const apostas = odds.map(o => (total * (1 / o)) / somaInversa);
    const retornoPotencial = odds.length > 0 ? apostas[0] * odds[0] : 0; 
    const lucro = retornoPotencial - total; 
    const arbitragemPercent = somaInversa < 1 ? (1/somaInversa - 1)*100 : 0;
    const oddEfetiva = total > 0 ? retornoPotencial / total : 0;

    let texto = `--- RESULTADO DO DUTCHING POR VALOR TOTAL ---\n\n`;
    texto += apostas.map((v, i) => {
        return `Aposta na Odd ${formatOutput(odds[i])}: R$ ${formatOutput(v)}`;
    }).join('\n');
    texto += `\n\nTotal Apostado: R$ ${formatOutput(total)}\n`;
    texto += `Retorno Potencial (se uma das sele√ß√µes vencer): R$ ${formatOutput(retornoPotencial)}\n`;
    texto += `Lucro (se uma das sele√ß√µes vencer): R$ ${formatOutput(lucro)}\n`;
    texto += `Odd Efetiva: ${formatOutput(oddEfetiva)}\n\n`;
    texto += `Possibilidade de Arbitragem (Lucro Garantido): ${somaInversa < 1 ? '‚úÖ Sim (' + formatOutput(arbitragemPercent) + '%)' : '‚ùå N√£o'}`;
    rd.innerText = texto; rd.style.display = 'block';
}

function calcularDutchingOtimizado() {
    const totalStake = parseInput('dutch_prob_total_valor');
    const rd = document.getElementById('resultado_dutching_otimizado');
    const selections = [];
    for (let i = 1; i <= 4; i++) {
        const odd = parseInput(`dutch_prob_odd_${i}`);
        const chance = parseInput(`dutch_prob_chance_${i}`);
        if (!isNaN(odd) && odd > 1 && !isNaN(chance) && chance >= 0 && chance <= 100) { 
            selections.push({ odd: odd, chance: chance / 100 }); 
        }
    }
    if (isNaN(totalStake) || totalStake <= 0 || selections.length === 0) {
        rd.innerText = 'ERRO: Preencha Valor Total (>0) e ao menos uma Sele√ß√£o (Odd >1 e Chance 0-100%).'; rd.style.display = 'block'; return;
    }
    
    const sumInvOdds = selections.reduce((acc, s) => acc + (1 / s.odd), 0);
    if (sumInvOdds === 0) {
         rd.innerText = 'ERRO: Odds inv√°lidas nas sele√ß√µes.'; rd.style.display = 'block'; return;
    }

    let texto = `--- DUTCHING OTIMIZADO POR PROBABILIDADE ---\n\n`;
    texto += `--- ALOCA√á√ÉO DAS STAKES (PARA MESMO LUCRO) & EV INDIVIDUAL ---\n\n`;
    let combinedProbOfWinningDutch = 0;
    selections.forEach((s, i) => {
        s.stake = (totalStake * (1 / s.odd)) / sumInvOdds; 
        s.ev = (s.odd * s.chance) - 1; 
        combinedProbOfWinningDutch += s.chance; 
        texto += `Sele√ß√£o ${i + 1} (Odd ${formatOutput(s.odd)}, Sua Chance ${formatOutput(s.chance * 100, 1)}%):\n`;
        texto += `  - Stake: R$ ${formatOutput(s.stake)}\n  - EV Individual: ${formatOutput(s.ev * 100, 1)}%\n\n`;
    });
    
    const expectedReturnIfWin = selections.length > 0 ? selections[0].stake * selections[0].odd : 0; 
    const profitIfWin = expectedReturnIfWin - totalStake;
    const effectiveOddDutch = selections.length > 0 && totalStake > 0 ? expectedReturnIfWin / totalStake : 0;
    const evDutch = selections.length > 0 ? (effectiveOddDutch * combinedProbOfWinningDutch) - 1 : 0; 
    const arbitragemPercent = sumInvOdds < 1 ? (1/sumInvOdds - 1)*100 : 0;

    texto += `--- RESULTADOS GERAIS DO DUTCHING ---\n\n`;
    texto += `Total Apostado: R$ ${formatOutput(totalStake)}\n`;
    texto += `Retorno Potencial (se uma das sele√ß√µes vencer): R$ ${formatOutput(expectedReturnIfWin)}\n`;
    texto += `Lucro (se uma das sele√ß√µes vencer): R$ ${formatOutput(profitIfWin)}\n`;
    texto += `Odd Efetiva do Dutching: ${formatOutput(effectiveOddDutch)}\n\n`;
    texto += `Probabilidade Combinada de Vencer (Sua Estimativa): ${formatOutput(combinedProbOfWinningDutch * 100, 1)}%\n`;
    texto += `Valor Esperado (EV) do Dutching Completo (Baseado na sua Prob.): ${formatOutput(evDutch * 100, 1)}%\n\n`;
    texto += `Possibilidade de Arbitragem (Lucro Garantido): ${sumInvOdds < 1 ? '‚úÖ Sim (' + formatOutput(arbitragemPercent) + '%)' : '‚ùå N√£o'}`;
    rd.innerText = texto; rd.style.display = 'block';
}

function calcularDutchingPorValores() {
    const rd = document.getElementById('resultado_dutching_valores');
    const apostas = [];
    const odds = [];
    let totalInvestido = 0;

    for (let i = 1; i <= 6; i++) {
        const valorAposta = parseInput(`dutch_val_${i}`);
        const oddAposta = parseInput(`dutch_odd_${i}`);
        if (!isNaN(valorAposta) && valorAposta > 0 && !isNaN(oddAposta) && oddAposta > 1) {
            apostas.push(valorAposta); 
            odds.push(oddAposta); 
            totalInvestido += valorAposta;
        }
    }

    if (apostas.length === 0) {
        rd.innerText = 'ERRO: Preencha ao menos um par de aposta (>0) e odd (>1) v√°lidas.'; 
        rd.style.display = 'block'; 
        return;
    }

    let texto = `--- AN√ÅLISE DOS RESULTADOS POR VALORES INDIVIDUAIS ---\n\n`;
    texto += `Total Investido: R$ ${formatOutput(totalInvestido)}\n\n`;
    
    apostas.forEach((valor, i) => {
        const retorno = valor * odds[i];
        const lucro = retorno - totalInvestido;
        const oddEfetiva = totalInvestido > 0 ? retorno / totalInvestido : 0;
        texto += `Se Aposta ${i + 1} (R$ ${formatOutput(valor)} @ ${formatOutput(odds[i])}) vencer:\n`;
        texto += `  - Retorno: R$ ${formatOutput(retorno)}\n`;
        texto += `  - Lucro: R$ ${formatOutput(lucro)}\n`;
        texto += `  - Odd Efetiva sobre o total: ${formatOutput(oddEfetiva)}\n\n`;
    });
    
    rd.innerText = texto.trim(); 
    rd.style.display = 'block';
}

// ===================================================================================
// SE√á√ÉO 4: INICIALIZA√á√ÉO DA P√ÅGINA
// ===================================================================================
document.addEventListener('DOMContentLoaded', () => {
    showCalculator('contexto');
    atualizarPreviewRelatorio();
});
</script>
</body>
</html>
